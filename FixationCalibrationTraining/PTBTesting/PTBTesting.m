% Clear the workspace
close all;
clear;
sca;

% Here we call some default settings for setting up Psychtoolbox
PsychDefaultSetup(2);

% Get the screen numbers
screens = Screen('Screens');

% Draw to the external screen if avaliable
screenNumber = max(screens);

% Define black and white
white = WhiteIndex(screenNumber);
black = BlackIndex(screenNumber);
grey = white / 2;
inc = white - grey;

% Open an on screen window
[window, windowRect] = PsychImaging('OpenWindow', screenNumber, grey);

% Get the size of the on screen window
[screenXpixels, screenYpixels] = Screen('WindowSize', window);

% Query the frame duration
ifi = Screen('GetFlipInterval', window);

% Get the centre coordinate of the window
[xCenter, yCenter] = RectCenter(windowRect);

% Set up alpha-blending for smooth (anti-aliased) lines
Screen('BlendFunction', window, 'GL_SRC_ALPHA', 'GL_ONE_MINUS_SRC_ALPHA');

% Manually insert location of images
%theImageLocations = {'33066.jpg', '35008.jpg', '35091.jpg', '59078.jpg','385039.jpg', '69020.jpg',...
  %                    '65132.jpg', '67079.jpg', '92059.jpg', '100098.jpg', '108073.jpg', '109034.jpg',...
  %                    '113009.jpg', '130034.jpg', '157036.jpg', '166081.jpg', '170054.jpg', '176039.jpg',...
  %                    '227046.jpg', '253036.jpg', '274007.jpg', '285036.jpg', '292066.jpg', '309004.jpg',...
  %                    '365073.jpg', '372047.jpg', '385028.jpg', '159029.jpg', '20008.jpg', '155060.jpg',...
  %                    '286092.jpg', '100075.jpg', '61060.jpg', '46076.jpg', '301007.jpg', '26031.jpg',...
  %                    '232038.jpg', '45077.jpg', '365025.jpg', '188091.jpg', '299091.jpg', '181079.jpg',...
  %                    '22090.jpg', '370036.jpg', '15088.jpg', '22093.jpg', '376020.jpg', '187071.jpg',...
  %                    '105053.jpg', '271008.jpg', '277095.jpg', '198023.jpg', '65074.jpg', '189003.jpg',...
  %                    '187029.jpg', '103041.jpg', '163014.jpg', '56028.jpg', '55075.jpg', '41004.jpg',...
  %                    '198054.jpg', '28096.jpg', '12003.jpg', '187039.jpg', '76002.jpg', '42044.jpg',...
  %                    '122048.jpg', '145053.jpg', '68077.jpg', '361084.jpg', '43083.jpg', '236017.jpg',...
  %                    '35058.jpg', '66075.jpg', '374020.jpg', '94079.jpg', '138078.jpg', '245051.jpg',...
  %                    '209070.jpg', '27059.jpg', '176019.jpg', '54005.jpg', '249087.jpg', '249061.jpg',...
  %                    '317080.jpg', '172032.jpg', '147062.jpg', '163062.jpg', '140075.jpg', '260081.jpg',...
  %                    '353013.jpg', '374067.jpg', '164074.jpg', '104022.jpg', '135037.jpg', '42078.jpg',...
  %                    '134052.jpg', '268002.jpg', '16052.jpg', '247085.jpg', '302003.jpg', '227040.jpg'...
  %                    '246053.jpg', '2092.jpg', '183055.jpg', '239096.jpg', '216053.jpg', '55067.jpg',...
  %                    '71046.jpg', '113044.jpg', '207056.jpg', '310007.jpg', '169012.jpg', '216041.jpg',...
  %                    '198004.jpg', '181091.jpg', '181018.jpg', '28075.jpg', '41025.jpg', '65019.jpg',...
  %                    '80099.jpg', '97017.jpg', '65010.jpg', '323016.jpg', '311068.jpg', '78019.jpg',...
  %                    '135069.jpg', '231015.jpg', '23084.jpg', '147021.jpg', '159091.jpg', '25098.jpg',...
  %                    '8143.jpg', '24004.jpg', '23025.jpg', '188005.jpg', '145014.jpg', '189011.jpg',...
  %                    '48055.jpg', '35010.jpg', '15004.jpg', '100080.jpg', '161062.jpg', '126039.jpg',...
  %                    '254054.jpg', '239007.jpg', '118035.jpg', '113016.jpg', '238011.jpg', '61086.jpg',...
  %                    '151087.jpg', '106025.jpg', '159045.jpg', '43070.jpg', '112082.jpg', '105019.jpg',...
  %                    '368078.jpg', '117054.jpg', '134008.jpg', '35070.jpg', '388016.jpg', '24063.jpg',...
  %                    '140055.jpg', '178054.jpg', '90076.jpg', '106020.jpg', '368016.jpg', '144067.jpg',...
  %                    '216066.jpg', '153093.jpg', '293029.jpg', '311081.jpg', '124084.jpg', '246016.jpg',...
  %                    '156079.jpg', '254033.jpg', '95006.jpg', '60079.jpg', '225017.jpg', '188063.jpg',...
  %                    '326038.jpg', '118020.jpg', '12074.jpg', '173036.jpg', '187083.jpg', '176035.jpg',...
  %                    '187003.jpg', '66039.jpg', '153077.jpg', '271031.jpg', '23080.jpg', '202012.jpg',...
  %                    '196015.jpg', '108041.jpg', '376001.jpg', '242078.jpg', '138032.jpg', '8049.jpg',...
  %                    '314016.jpg', '22013.jpg', '87065.jpg', '183087.jpg', '119082.jpg', '170057.jpg',...
  %                    '58060.jpg', '163085.jpg', '42049.jpg', '167062.jpg', '157055.jpg', '295087.jpg',...
  %                    '24077.jpg', '78004.jpg', '220075.jpg', '45096.jpg', '38092.jpg', '43074.jpg',...
  %                    '16077.jpg', '86000.jpg', '101085.jpg', '219090.jpg', '89072.jpg', '300091.jpg',...
  %                    '126007.jpg', '156065.jpg', '76053.jpg', '296007.jpg', '175032.jpg', '253027.jpg',...
  %                    '304034.jpg', '86016.jpg', '103070.jpg', '8023.jpg', '260058.jpg', '41033.jpg',...
  %                    '291000.jpg', '109053.jpg', '130026.jpg', '241004.jpg', '108082.jpg', '285079.jpg',...
  %                    '147091.jpg', '69040.jpg', '14037.jpg', '54082.jpg', '189080.jpg', '229036.jpg',...
  %                    '62096.jpg', '271035.jpg', '167083.jpg', '12084.jpg', '69015.jpg', '148089.jpg',...
  %                    '160068.jpg', '145086.jpg', '216081.jpg', '97033.jpg', '182053.jpg', '208001.jpg',...
  %                    '19021.jpg', '227092.jpg', '134035.jpg', '223061.jpg', '253055.jpg', '148026.jpg',...
  %                    '210088.jpg', '86068.jpg', '3096.jpg', '41069.jpg', '21077.jpg', '196073.jpg',...
  %                    '108070.jpg', '123074.jpg', '376043.jpg', '306005.jpg', '38082.jpg', '33039.jpg',...
  %                    '108005.jpg', '106024.jpg', '302008.jpg', '102061.jpg', '197017.jpg', '299086.jpg',...
  %                    '37073.jpg', '241048.jpg', '65033.jpg', '55073.jpg', '66053.jpg', '143090.jpg',...
  %                    '85048.jpg', '42012.jpg', '351093.jpg', '361010.jpg', '175043.jpg', '87046.jpg',...
  %                   '105025.jpg', '236037.jpg', '101087.jpg', '304074.jpg', '296059.jpg', '159008.jpg'};

% Create cells to store the images and image textures
theImages = cell(1, numel(theImageLocations));
imageTextures = cell(1, numel(theImageLocations));

% Processing the images
for i = 1:numel(theImages)
    % Here we load in an image from file. This one is a image of rabbits that
    % is included with PTB
    theImages{i} = imread(theImageLocations{i});
    theImages{i} = theImages{i} - 64;

    % Resize and Get the size of the image
    [s1, s2, s3] = size(theImages{i});

    % Here we check if the image is too big to fit on the screen and abort if
    % it is. See ImageRescaleDemo to see how to rescale an image.
    if s1 > screenYpixels || s2 > screenYpixels
        disp('ERROR! Image is too big to fit on the screen');
        sca;
        return;
    end

    % Turn images into 4-dimensional cells
    theImage4D = ones(s1, s2, 4);
    theImage4D(:, :, 1:3) = theImages{i};
    
    % Create the cosine window
    [cos_window] = raised_cosine(240,50,s2,s1,0,0,'R');
    
    % Turn the cosine window into 4-dimensional cell
    alpha = ones(s1, s2, 4);
    alpha(:,:, 4) = cos_window;

    % Alpha Blend the images with cosine window
    %theImageAlpha = AlphaBlend('GL_SRC_ALPHA', 'GL_ONE_MINUS_SRC_ALPHA',  theImage4D, alpha);
    %theImageAlpha = AlphaTimes(theImage4D, cos_window);
    
    alpha = zeros(s1,s2,3);
    alpha(:,:,1) = cos_window;
    alpha(:,:,2) = cos_window;
    alpha(:,:,3) = cos_window;
    theImages{i} = theImages{i} .* alpha;
    
    theImages{i} = theImages{i} + 128;

    
    % Make the image into a texture
    imageTextures{i} = Screen('MakeTexture', window, theImages{i});

end



% Numer of frames to wait before re-drawing
waitframes = 100;

% Start timestamp
vbl = Screen('Flip', window);

counter = 0;
while ~KbCheck
    counter = counter + 1;
    if counter > numel(theImages)
        %counter = 1;
        counter = randi([1 numel(theImages)], 1);
    end

    Screen('DrawTexture', window, imageTextures{counter}, [], [], 0);
    vbl = Screen('Flip', window, vbl + (waitframes - 0.5) * ifi);

end


% Clear the screen
sca;